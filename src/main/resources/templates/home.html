<!DOCTYPE html>
<html
  lang="ko"
  xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  xmlns:th="http://www.thymeleaf.org"
>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fashion Store - 메인</title>
    <link th:href="@{/css/style.css}" rel="stylesheet" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <header class="header">
      <div class="container">
        <div class="logo">
          <h1><a href="/home">Fashion Store</a></h1>
        </div>
        <nav class="nav">
          <div class="search-container">
            <input
              type="text"
              id="searchInput"
              placeholder="상품을 검색하세요..."
            />
            <button onclick="searchProducts()">검색</button>
          </div>
          <div class="nav-buttons">
            <button onclick="goToMyPage()">마이페이지</button>
            <button onclick="goToCart()">
              장바구니 (<span id="cartCount">0</span>)
            </button>

            <div sec:authorize="isAuthenticated()">
              <span sec:authentication="name">사용자 이메일</span>
              <a class="nav-link" href="/logout">로그아웃</a>
            </div>

            <div sec:authorize="!isAuthenticated()">
              <button onclick="goToLogin()" id="loginBtn">로그인</button>
              <button onclick="goToSignup()">회원가입</button>
            </div>
          </div>
        </nav>
      </div>
    </header>

    <main class="main">
      <div class="container">
        <section class="categories">
          <h2>카테고리</h2>
          <div class="category-grid">
            <div class="category-card" onclick="filterByCategory('하의')">
              <h3>바지</h3>
              <p>편안한 바지 컬렉션</p>
            </div>
            <div class="category-card" onclick="filterByCategory('신발')">
              <h3>신발</h3>
              <p>스타일리시한 신발</p>
            </div>
            <div class="category-card" onclick="filterByCategory('상의')">
              <h3>상의</h3>
              <p>트렌디한 상의</p>
            </div>
            <div class="category-card" onclick="filterByCategory('아우터')">
              <h3>아우터</h3>
              <p>따뜻한 아우터</p>
            </div>
            <div class="category-card" onclick="filterByCategory('원피스')">
              <h3>원피스</h3>
              <p>지금 아니면 못사즌 원피스</p>
            </div>
            <div class="category-card" onclick="filterByCategory('가방')">
              <h3>가방</h3>
              <p>아직도 백팩 매고 다니게?</p>
            </div>
            <div class="category-card" onclick="filterByCategory('액세서리')">
              <h3>악세서리</h3>
              <p>악세서리 하나만으로 분위기를 다르게</p>
            </div>
            <div
              class="category-card"
              onclick="filterByCategory('기타/알 수 없음')"
            >
              <h3>기타/알 수 없음</h3>
              <p>다른 쇼핑몰 갈 필요 없이 여기서 원클릭으로!</p>
            </div>
          </div>
        </section>

        <section class="products">
          <div class="products-header">
            <h2>상품 목록</h2>
            <button onclick="showAllProducts()" class="show-all-btn">
              전체 보기
            </button>
          </div>
          <div class="product-grid" id="productGrid">
            <!-- 상품들이 JavaScript로 동적 생성됩니다 -->
          </div>
          <!-- [lsr/feature/paging] 상품 목록 페이지네이션 UI를 위한 영역 추가 -->
          <div class="pagination" id="productPagination">
            <!-- JavaScript로 동적 생성 -->
          </div>
        </section>
      </div>
    </main>

    <footer class="footer">
      <div class="container">
        <p>&copy; 2024 Fashion Store. All rights reserved.</p>
      </div>
    </footer>

    <script layout:fragment="script" th:inline="javascript">
      // html이 렌더링 되기 전에 이 함수를 실행시켜라
      // fetch -> RestAPI를 실행시키기 위한 명령어
      window.onload = function () {
        // [lsr/feature/paging] 페이지 로딩 시, 검색 조건 없이 첫 페이지를 가져옵니다.
        getProducts(1, "", "");
      };
      // products라는 데이터가 전달 됨 List형식
      // 페이지 로딩 시 장바구니 개수 업데이트
      document.addEventListener("DOMContentLoaded", function () {
        updateCartCount();
      });

      function updateCartCount() {
        fetch("/api/cart")
          .then((res) => {
            if (!res.ok) throw new Error("장바구니 불러오기 실패");
            return res.json();
          })
          .then((data) => {
            const count = data.length;
            document.getElementById("cartCount").textContent = count;
          })
          .catch((err) => {
            console.error(err);
            // 오류 시 0으로 설정
            document.getElementById("cartCount").textContent = 0;
          });
      }

      function goToCart() {
        window.location.href = "/cart";
      }

      /**
       * [lsr/feature/paging] 상품 목록을 화면에 표시하는 함수 (수정)
       * 이유: 기존에는 상품 배열을 직접 받았지만, 이제는 페이지 정보가 포함된 PageResponseDTO 객체를 받도록 수정합니다.
       * @param pageData PageResponseDTO 객체
       */
      function displayProducts(pageData) {
        const productGrid = document.getElementById("productGrid");
        if (!productGrid) return;
        productGrid.innerHTML = "";

        const productsToShow = pageData.dtoList; // 실제 상품 목록은 dtoList에 들어있습니다.

        if (!productsToShow || productsToShow.length === 0) {
          productGrid.innerHTML = "<p>표시할 상품이 없습니다.</p>";
          return;
        }

        productsToShow.forEach((product) => {
          const productCard = document.createElement("div");
          productCard.className = "product-card";

          productCard.innerHTML = `
            <div class="product-image">${product.image || "이미지 없음"}</div>
            <div class="product-info">
                <h3 onclick="goToProductDetail(${product.productId})">${
            product.productName
          }</h3>
                <p>카테고리: ${product.productTag}</p>
                <div class="product-price">${Number(
                  product.price
                ).toLocaleString()}원</div>
                <button class="add-to-cart-btn" onclick="addToCart(${
                  product.productId
                }, '${product.productName}')">
                    장바구니 담기
                </button>
            </div>
        `;
          productGrid.appendChild(productCard);
        });
      }

      /**
       * [lsr/feature/paging] 상품 목록을 가져오는 메인 함수 (확장)
       * 이유: 일반 목록 조회, 검색, 카테고리 필터링을 모두 처리하기 위해 type과 keyword를 파라미터로 받도록 확장합니다.
       * @param page 요청할 페이지 번호
       * @param type 검색 타입 (n: 이름, t: 태그/카테고리)
       * @param keyword 검색어
       */
      function getProducts(page, type, keyword) {
        // 파라미터가 없으면 빈 문자열로 초기화
        const pageNum = page || 1;
        const searchType = type || "";
        const searchKeyword = keyword || "";

        fetch(
          `/api/products?page=${pageNum}&type=${searchType}&keyword=${searchKeyword}`
        )
          .then((response) => response.json())
          .then((pageData) => {
            displayProducts(pageData);
            renderProductPagination(pageData, searchType, searchKeyword); // 페이지네이션에도 검색 조건 전달
          })
          .catch((error) =>
            console.error("상품 정보를 불러오는 중 오류 발생:", error)
          );
      }

      /**
       * [lsr/feature/paging] 상품 목록 페이지네이션 UI를 생성하는 함수 (신규)
       * @param pageData PageResponseDTO 객체
       */
      /**
       * [lsr/feature/paging] 페이지네이션 UI를 생성하는 함수 (수정)
       * 이유: 페이지 이동 시에도 현재의 검색 조건을 유지하기 위해 type과 keyword를 함께 전달합니다.
       * @param pageData PageResponseDTO 객체
       * @param type 현재 검색 타입
       * @param keyword 현재 검색어
       */
      function renderProductPagination(pageData, type, keyword) {
        const pagination = document.getElementById("productPagination");
        pagination.innerHTML = "";

        if (pageData.prev) {
          const prevBtn = document.createElement("a");
          prevBtn.href = "#";
          prevBtn.innerText = "이전";
          prevBtn.onclick = (e) => {
            e.preventDefault();
            getProducts(pageData.prevPage, type, keyword);
          };
          pagination.appendChild(prevBtn);
        }

        pageData.pageNumList.forEach((pageNum) => {
          const pageBtn = document.createElement("a");
          pageBtn.href = "#";
          pageBtn.innerText = pageNum;
          if (pageNum === pageData.current) {
            pageBtn.classList.add("active");
          }
          pageBtn.onclick = (e) => {
            e.preventDefault();
            getProducts(pageNum, type, keyword);
          };
          pagination.appendChild(pageBtn);
        });

        if (pageData.next) {
          const nextBtn = document.createElement("a");
          nextBtn.href = "#";
          nextBtn.innerText = "다음";
          nextBtn.onclick = (e) => {
            e.preventDefault();
            getProducts(pageData.nextPage, type, keyword);
          };
          pagination.appendChild(nextBtn);
        }
      }

      function goToProductDetail(productId) {
        window.location.href = `/products/${productId}`;
      }

      function addToCart(productId, productName) {
        const payload = {
          productId: productId,
          quantity: 1,
        };

        fetch("/api/cart", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload),
        })
          .then((res) => {
            if (!res.ok) {
              throw new Error("장바구니 추가에 실패했습니다.");
            }
            return res.json();
          })
          .then((data) => {
            alert(`🛒 ${productName}이(가) 장바구니에 추가되었습니다.`);
            updateCartCount();
          })
          .catch((err) => {
            console.error(err);
            alert("장바구니 추가 중 오류가 발생했습니다.");
          });
      }

      function filterByCategory(category) {
        // [lsr/feature/paging] 카테고리 필터링 시, 검색어를 비우고 타입 't'로 조회
        document.getElementById("searchInput").value = "";
        getProducts(1, "t", category);
      }

      // 전체 상품 보기 (home.html)
      function showAllProducts() {
        document.getElementById("searchInput").value = ""; // 검색어 초기화
        getProducts(1);
      }

      // 상품 검색 (home.html)
      function searchProducts() {
        // [lsr/feature/paging] 상품명 검색 시, 타입 'n'으로 조회
        const keyword = document.getElementById("searchInput").value;
        getProducts(1, "n", keyword);
      }

      // [lsr/feature/paging] 팀원의 '엔터 키 검색' 기능 추가
      document.addEventListener("keypress", function (event) {
        if (event.key === "Enter" && event.target.id === "searchInput") {
          searchProducts();
        }
      });
    </script>
    <script src="/js/script.js"></script>
  </body>
</html>
