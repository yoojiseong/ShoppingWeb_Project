<!DOCTYPE html>
<html
  lang="ko"
  xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  xmlns:th="http://www.thymeleaf.org"
>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fashion Store - ë©”ì¸</title>
    <link th:href="@{/css/style.css}" rel="stylesheet" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <header class="header">
      <div class="container">
        <div class="logo">
          <h1><a href="/home">Fashion Store</a></h1>
        </div>
        <nav class="nav">
          <div class="search-container">
            <input
              type="text"
              id="searchInput"
              placeholder="ìƒí’ˆì„ ê²€ìƒ‰í•˜ì„¸ìš”..."
            />
            <button onclick="searchProducts()">ê²€ìƒ‰</button>
          </div>
          <div class="nav-buttons">
            <button onclick="goToMyPage()">ë§ˆì´í˜ì´ì§€</button>
            <button onclick="goToCart()">
              ì¥ë°”êµ¬ë‹ˆ (<span id="cartCount">0</span>)
            </button>

            <div sec:authorize="isAuthenticated()">
              <span sec:authentication="name">ì‚¬ìš©ì ì´ë©”ì¼</span>
              <a class="nav-link" href="/logout">ë¡œê·¸ì•„ì›ƒ</a>
            </div>

            <div sec:authorize="!isAuthenticated()">
              <button onclick="goToLogin()" id="loginBtn">ë¡œê·¸ì¸</button>
              <button onclick="goToSignup()">íšŒì›ê°€ì…</button>
            </div>
          </div>
        </nav>
      </div>
    </header>

    <main class="main">
      <div class="container">
        <section class="categories">
          <h2>ì¹´í…Œê³ ë¦¬</h2>
          <div class="category-grid">
            <div class="category-card" onclick="filterByCategory('í•˜ì˜')">
              <h3>ë°”ì§€</h3>
              <p>í¸ì•ˆí•œ ë°”ì§€ ì»¬ë ‰ì…˜</p>
            </div>
            <div class="category-card" onclick="filterByCategory('ì‹ ë°œ')">
              <h3>ì‹ ë°œ</h3>
              <p>ìŠ¤íƒ€ì¼ë¦¬ì‹œí•œ ì‹ ë°œ</p>
            </div>
            <div class="category-card" onclick="filterByCategory('ìƒì˜')">
              <h3>ìƒì˜</h3>
              <p>íŠ¸ë Œë””í•œ ìƒì˜</p>
            </div>
            <div class="category-card" onclick="filterByCategory('ì•„ìš°í„°')">
              <h3>ì•„ìš°í„°</h3>
              <p>ë”°ëœ»í•œ ì•„ìš°í„°</p>
            </div>
            <div class="category-card" onclick="filterByCategory('ì›í”¼ìŠ¤')">
              <h3>ì›í”¼ìŠ¤</h3>
              <p>ì§€ê¸ˆ ì•„ë‹ˆë©´ ëª»ì‚¬ì¦Œ ì›í”¼ìŠ¤</p>
            </div>
            <div class="category-card" onclick="filterByCategory('ê°€ë°©')">
              <h3>ê°€ë°©</h3>
              <p>ì•„ì§ë„ ë°±íŒ© ë§¤ê³  ë‹¤ë‹ˆê²Œ?</p>
            </div>
            <div class="category-card" onclick="filterByCategory('ì•¡ì„¸ì„œë¦¬')">
              <h3>ì•…ì„¸ì„œë¦¬</h3>
              <p>ì•…ì„¸ì„œë¦¬ í•˜ë‚˜ë§Œìœ¼ë¡œ ë¶„ìœ„ê¸°ë¥¼ ë‹¤ë¥´ê²Œ</p>
            </div>
            <div
              class="category-card"
              onclick="filterByCategory('ê¸°íƒ€/ì•Œ ìˆ˜ ì—†ìŒ')"
            >
              <h3>ê¸°íƒ€/ì•Œ ìˆ˜ ì—†ìŒ</h3>
              <p>ë‹¤ë¥¸ ì‡¼í•‘ëª° ê°ˆ í•„ìš” ì—†ì´ ì—¬ê¸°ì„œ ì›í´ë¦­ìœ¼ë¡œ!</p>
            </div>
          </div>
        </section>

        <section class="products">
          <div class="products-header">
            <h2>ìƒí’ˆ ëª©ë¡</h2>
            <button onclick="showAllProducts()" class="show-all-btn">
              ì „ì²´ ë³´ê¸°
            </button>
          </div>
          <div class="product-grid" id="productGrid">
            <!-- ìƒí’ˆë“¤ì´ JavaScriptë¡œ ë™ì  ìƒì„±ë©ë‹ˆë‹¤ -->
          </div>
          <!-- [lsr/feature/paging] ìƒí’ˆ ëª©ë¡ í˜ì´ì§€ë„¤ì´ì…˜ UIë¥¼ ìœ„í•œ ì˜ì—­ ì¶”ê°€ -->
          <div class="pagination" id="productPagination">
            <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
          </div>
        </section>
      </div>
    </main>

    <footer class="footer">
      <div class="container">
        <p>&copy; 2024 Fashion Store. All rights reserved.</p>
      </div>
    </footer>

    <script layout:fragment="script" th:inline="javascript">
      // htmlì´ ë Œë”ë§ ë˜ê¸° ì „ì— ì´ í•¨ìˆ˜ë¥¼ ì‹¤í–‰ì‹œì¼œë¼
      // fetch -> RestAPIë¥¼ ì‹¤í–‰ì‹œí‚¤ê¸° ìœ„í•œ ëª…ë ¹ì–´
      window.onload = function () {
        // [lsr/feature/paging] í˜ì´ì§€ ë¡œë”© ì‹œ, ì „ì²´ ëª©ë¡ ëŒ€ì‹  ì²« í˜ì´ì§€ë¥¼ ê°€ì ¸ì˜¤ë„ë¡ ìˆ˜ì •
        getProducts(1);
      };
      // productsë¼ëŠ” ë°ì´í„°ê°€ ì „ë‹¬ ë¨ Listí˜•ì‹
      // í˜ì´ì§€ ë¡œë”© ì‹œ ì¥ë°”êµ¬ë‹ˆ ê°œìˆ˜ ì—…ë°ì´íŠ¸
      document.addEventListener("DOMContentLoaded", function () {
        updateCartCount();
      });

      function updateCartCount() {
        fetch("/api/cart")
          .then((res) => {
            if (!res.ok) throw new Error("ì¥ë°”êµ¬ë‹ˆ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
            return res.json();
          })
          .then((data) => {
            const count = data.length;
            document.getElementById("cartCount").textContent = count;
          })
          .catch((err) => {
            console.error(err);
            // ì˜¤ë¥˜ ì‹œ 0ìœ¼ë¡œ ì„¤ì •
            document.getElementById("cartCount").textContent = 0;
          });
      }

      function goToCart() {
        window.location.href = "/cart";
      }

      /**
       * [lsr/feature/paging] ìƒí’ˆ ëª©ë¡ì„ í™”ë©´ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜ (ìˆ˜ì •)
       * ì´ìœ : ê¸°ì¡´ì—ëŠ” ìƒí’ˆ ë°°ì—´ì„ ì§ì ‘ ë°›ì•˜ì§€ë§Œ, ì´ì œëŠ” í˜ì´ì§€ ì •ë³´ê°€ í¬í•¨ëœ PageResponseDTO ê°ì²´ë¥¼ ë°›ë„ë¡ ìˆ˜ì •í•©ë‹ˆë‹¤.
       * @param pageData PageResponseDTO ê°ì²´
       */
      function displayProducts(pageData) {
        const productGrid = document.getElementById("productGrid");
        if (!productGrid) return;
        productGrid.innerHTML = "";

        const productsToShow = pageData.dtoList; // ì‹¤ì œ ìƒí’ˆ ëª©ë¡ì€ dtoListì— ë“¤ì–´ìˆìŠµë‹ˆë‹¤.

        if (!productsToShow || productsToShow.length === 0) {
          productGrid.innerHTML = "<p>í‘œì‹œí•  ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>";
          return;
        }

        productsToShow.forEach((product) => {
          const productCard = document.createElement("div");
          productCard.className = "product-card";

          productCard.innerHTML = `
            <div class="product-image">${product.image || "ì´ë¯¸ì§€ ì—†ìŒ"}</div>
            <div class="product-info">
                <h3 onclick="goToProductDetail(${product.productId})">${
            product.productName
          }</h3>
                <p>ì¹´í…Œê³ ë¦¬: ${product.productTag}</p>
                <div class="product-price">${Number(
                  product.price
                ).toLocaleString()}ì›</div>
                <button class="add-to-cart-btn" onclick="addToCart(${
                  product.productId
                }, '${product.productName}')">
                    ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°
                </button>
            </div>
        `;
          productGrid.appendChild(productCard);
        });
      }

      /**
       * [lsr/feature/paging] íŠ¹ì • í˜ì´ì§€ì˜ ìƒí’ˆ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” ë©”ì¸ í•¨ìˆ˜ (ì‹ ê·œ)
       * @param page ìš”ì²­í•  í˜ì´ì§€ ë²ˆí˜¸
       */
      function getProducts(page) {
        const searchInput = document.getElementById("searchInput");
        const keyword = searchInput.value;
        // í˜„ì¬ëŠ” ì´ë¦„(n)ìœ¼ë¡œë§Œ ê²€ìƒ‰ íƒ€ì…ì„ ê³ ì •í•©ë‹ˆë‹¤. ì¶”í›„ í™•ì¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.
        const type = "n";

        fetch(`/api/products?page=${page}&type=${type}&keyword=${keyword}`)
          .then((response) => response.json())
          .then((pageData) => {
            displayProducts(pageData);
            renderProductPagination(pageData);
          })
          .catch((error) =>
            console.error("ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error)
          );
      }

      /**
       * [lsr/feature/paging] ìƒí’ˆ ëª©ë¡ í˜ì´ì§€ë„¤ì´ì…˜ UIë¥¼ ìƒì„±í•˜ëŠ” í•¨ìˆ˜ (ì‹ ê·œ)
       * @param pageData PageResponseDTO ê°ì²´
       */
      function renderProductPagination(pageData) {
        const pagination = document.getElementById("productPagination");
        pagination.innerHTML = "";

        if (pageData.prev) {
          const prevBtn = document.createElement("a");
          prevBtn.href = "#";
          prevBtn.innerText = "ì´ì „";
          prevBtn.onclick = (e) => {
            e.preventDefault();
            getProducts(pageData.prevPage);
          };
          pagination.appendChild(prevBtn);
        }

        pageData.pageNumList.forEach((pageNum) => {
          const pageBtn = document.createElement("a");
          pageBtn.href = "#";
          pageBtn.innerText = pageNum;
          if (pageNum === pageData.current) {
            pageBtn.classList.add("active");
          }
          pageBtn.onclick = (e) => {
            e.preventDefault();
            getProducts(pageNum);
          };
          pagination.appendChild(pageBtn);
        });

        if (pageData.next) {
          const nextBtn = document.createElement("a");
          nextBtn.href = "#";
          nextBtn.innerText = "ë‹¤ìŒ";
          nextBtn.onclick = (e) => {
            e.preventDefault();
            getProducts(pageData.nextPage);
          };
          pagination.appendChild(nextBtn);
        }
      }

      function goToProductDetail(productId) {
        window.location.href = `/products/${productId}`;
      }

      function addToCart(productId, productName) {
        const payload = {
          productId: productId,
          quantity: 1,
        };

        fetch("/api/cart", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload),
        })
          .then((res) => {
            if (!res.ok) {
              throw new Error("ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
            return res.json();
          })
          .then((data) => {
            alert(`ğŸ›’ ${productName}ì´(ê°€) ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            updateCartCount();
          })
          .catch((err) => {
            console.error(err);
            alert("ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          });
      }

      function filterByCategory(category) {
        // [lsr/feature/paging] ì¹´í…Œê³ ë¦¬ í•„í„°ë§ë„ í˜ì´ì§•ê³¼ ì—°ë™ë˜ë„ë¡ ì¶”í›„ ìˆ˜ì • í•„ìš”
        console.log(
          `'${category}' ì¹´í…Œê³ ë¦¬ í•„í„°ë§ ê¸°ëŠ¥ì€ í˜ì´ì§•ê³¼ ì—°ë™í•´ì•¼ í•©ë‹ˆë‹¤.`
        );
        // fetch(`/api/products?category=${encodeURIComponent(category)}`)
        //   .then((response) => response.json())
        //   .then((data) => {
        //     console.log("ğŸ“‚ ì¹´í…Œê³ ë¦¬ ê²°ê³¼:", data);
        //     displayProducts(data);
        //   });
      }

      // ì „ì²´ ìƒí’ˆ ë³´ê¸° (home.html)
      function showAllProducts() {
        document.getElementById("searchInput").value = ""; // ê²€ìƒ‰ì–´ ì´ˆê¸°í™”
        getProducts(1);
      }

      // ìƒí’ˆ ê²€ìƒ‰ (home.html)
      function searchProducts() {
        getProducts(1);
      }

      // [lsr/feature/paging] íŒ€ì›ì˜ 'ì—”í„° í‚¤ ê²€ìƒ‰' ê¸°ëŠ¥ ì¶”ê°€
      document.addEventListener("keypress", function (event) {
        if (event.key === "Enter" && event.target.id === "searchInput") {
          searchProducts();
        }
      });
    </script>
    <script src="/js/script.js"></script>
  </body>
</html>
