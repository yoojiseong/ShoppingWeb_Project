<!DOCTYPE html>
<html lang="ko"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fashion Store - ë©”ì¸</title>
    <link th:href="@{/css/style.css}" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
          crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</head>

<body>
<header class="header">
    <div class="container d-flex justify-content-between align-items-center py-3">
        <!-- ë¡œê³  -->
        <div class="logo">
            <h1><a href="/home" class="text-decoration-none text-dark">Fashion Store</a></h1>
        </div>

        <!-- ê²€ìƒ‰ì°½ -->
        <div class="search-container d-flex">
            <input type="text" id="searchInput" placeholder="ìƒí’ˆì„ ê²€ìƒ‰í•˜ì„¸ìš”..." class="form-control me-2">
            <button onclick="searchProducts()" class="btn btn-outline-primary">ê²€ìƒ‰</button>
        </div>

        <!-- ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ -->
        <div class="nav-buttons d-flex align-items-center gap-2">

            <!-- ê³µí†µ ë²„íŠ¼ -->

            <div class="d-flex justify-content-end gap-3 my-3">
                <button class="btn btn-outline-primary d-flex align-items-center gap-2" onclick="goToMyPage()">
                    <i class="bi bi-person-circle"></i> ë§ˆì´í˜ì´ì§€
                </button>

                <button class="btn btn-outline-success d-flex align-items-center gap-2" onclick="goToCart()">
                    <i class="bi bi-cart3"></i> ì¥ë°”êµ¬ë‹ˆ (<span id="cartCount">0</span>)
                </button>
            </div>

            <!-- ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œ -->
            <div sec:authorize="isAuthenticated()" class="d-flex align-items-center gap-2">
                <span sec:authentication="name" class="fw-bold text-primary"></span>
                <img th:if="${#authentication.principal instanceof T(org.springframework.security.oauth2.core.user.OAuth2User) and #authentication.principal.isKakaoUser()}"
                     th:src="@{/images/login/kakao_logo_small.png}"
                     alt="ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸"
                     style="width:20px; height:20px; margin-left:5px;" />
                <a href="/logout" class="btn btn-outline-danger btn-sm">ë¡œê·¸ì•„ì›ƒ</a>
            </div>

            <!-- ë¹„ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œ -->
            <div sec:authorize="!isAuthenticated()" class="d-flex gap-2">
                <button onclick="goToLogin()" class="btn btn-outline-primary btn-sm">ë¡œê·¸ì¸</button>
                <button onclick="goToSignup()" class="btn btn-outline-success btn-sm">íšŒì›ê°€ì…</button>
            </div>

            <!-- ê´€ë¦¬ì ì „ìš© ë²„íŠ¼ -->
            <div sec:authorize="hasRole('ADMIN')" class="d-flex flex-column align-items-start ms-3">
                <span class="text-danger fw-bold">ê´€ë¦¬ì ê³„ì •ì…ë‹ˆë‹¤</span>
                <div class="d-flex gap-2 mt-1">
                    <a href="/admin" class="btn btn-warning btn-sm">ê´€ë¦¬ì í˜ì´ì§€</a>
                </div>
            </div>

        </div>
    </div>
</header>

<main class="main">
    <div class="container">
        <section class="categories">
            <h2>ì¹´í…Œê³ ë¦¬</h2>
            <div class="category-grid">
                <div class="category-card" onclick="filterByCategory('í•˜ì˜')">
                    <h3>ë°”ì§€</h3>
                    <p>í¸ì•ˆí•œ ë°”ì§€ ì»¬ë ‰ì…˜</p>
                </div>
                <div class="category-card" onclick="filterByCategory('ì‹ ë°œ')">
                    <h3>ì‹ ë°œ</h3>
                    <p>ìŠ¤íƒ€ì¼ë¦¬ì‹œí•œ ì‹ ë°œ</p>
                </div>
                <div class="category-card" onclick="filterByCategory('ìƒì˜')">
                    <h3>ìƒì˜</h3>
                    <p>íŠ¸ë Œë””í•œ ìƒì˜</p>
                </div>
                <div class="category-card" onclick="filterByCategory('ì•„ìš°í„°')">
                    <h3>ì•„ìš°í„°</h3>
                    <p>ë”°ëœ»í•œ ì•„ìš°í„°</p>
                </div>
                <div class="category-card" onclick="filterByCategory('ì›í”¼ìŠ¤')">
                    <h3>ì›í”¼ìŠ¤</h3>
                    <p>ì§€ê¸ˆ ì•„ë‹ˆë©´ ëª»ì‚¬ì¦Œ ì›í”¼ìŠ¤</p>
                </div>
                <div class="category-card" onclick="filterByCategory('ê°€ë°©')">
                    <h3>ê°€ë°©</h3>
                    <p>ì•„ì§ë„ ë°±íŒ© ë§¤ê³  ë‹¤ë‹ˆê²Œ?</p>
                </div>
                <div class="category-card" onclick="filterByCategory('ì•¡ì„¸ì„œë¦¬')">
                    <h3>ì•…ì„¸ì„œë¦¬</h3>
                    <p>ì•…ì„¸ì„œë¦¬ í•˜ë‚˜ë§Œìœ¼ë¡œ ë¶„ìœ„ê¸°ë¥¼ ë‹¤ë¥´ê²Œ</p>
                </div>
                <div class="category-card" onclick="filterByCategory('ê¸°íƒ€/ì•Œ ìˆ˜ ì—†ìŒ')">
                    <h3>ê¸°íƒ€/ì•Œ ìˆ˜ ì—†ìŒ</h3>
                    <p>ë‹¤ë¥¸ ì‡¼í•‘ëª° ê°ˆ í•„ìš” ì—†ì´ ì—¬ê¸°ì„œ ì›í´ë¦­ìœ¼ë¡œ!</p>
                </div>
            </div>
        </section>

        <section class="products">
            <div class="products-header">
                <h2>ìƒí’ˆ ëª©ë¡</h2>
                <button onclick="showAllProducts()" class="show-all-btn">ì „ì²´ ë³´ê¸°</button>
            </div>
            <div class="product-grid" id="productGrid">
                <!-- ìƒí’ˆë“¤ì´ JavaScriptë¡œ ë™ì  ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
        </section>
    </div>
</main>

<footer class="footer">
    <div class="container">
        <p>&copy; 2024 Fashion Store. All rights reserved.</p>
    </div>
</footer>


<script layout:fragment="script" th:inline="javascript">

    // htmlì´ ë Œë”ë§ ë˜ê¸° ì „ì— ì´ í•¨ìˆ˜ë¥¼ ì‹¤í–‰ì‹œì¼œë¼
    // fetch -> RestAPIë¥¼ ì‹¤í–‰ì‹œí‚¤ê¸° ìœ„í•œ ëª…ë ¹ì–´
    window.onload = function(){
        fetch('/api/products')
            .then(response => response.json())
            //data => RestAPIì—ì„œ ë°›ì•„ì˜¨ ë°ì´í„°
            .then(data => {
                console.log("ì „ì²´ ìƒí’ˆ : ", data);
                displayProducts(data);
                window.allProducts = data;
            });
    }
    // productsë¼ëŠ” ë°ì´í„°ê°€ ì „ë‹¬ ë¨ Listí˜•ì‹
    // í˜ì´ì§€ ë¡œë”© ì‹œ ì¥ë°”êµ¬ë‹ˆ ê°œìˆ˜ ì—…ë°ì´íŠ¸
    document.addEventListener('DOMContentLoaded', function () {
        updateCartCount();
    });

    function updateCartCount() {
        fetch('/api/cart')
            .then(res => {
                if (!res.ok) throw new Error('ì¥ë°”êµ¬ë‹ˆ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
                return res.json();
            })
            .then(data => {
                const count = data.length;
                document.getElementById('cartCount').textContent = count;
            })
            .catch(err => {
                console.error(err);
                // ì˜¤ë¥˜ ì‹œ 0ìœ¼ë¡œ ì„¤ì •
                document.getElementById('cartCount').textContent = 0;
            });
    }

    function goToCart() {
        window.location.href = '/cart';
    }

    // ìƒí’ˆ í‘œì‹œ (home.html)
    function displayProducts(productsToShow) {
        const productGrid = document.getElementById('productGrid');
        if (!productGrid) return;
        productGrid.innerHTML = '';
        productsToShow.forEach(product => {
            const productCard = document.createElement('div');
            productCard.className = 'product-card';

            // ì¬ê³ ê°€ 0ì¸ì§€ í™•ì¸
            const isSoldOut = product.stock === 0;

            let soldOutOverlay = '';
            if (isSoldOut) {
                soldOutOverlay = `
                    <div class="sold-out-overlay">
                        <div class="sold-out-text">Sold Out</div>
                    </div>
                `;
            }

            productCard.innerHTML = `
                ${soldOutOverlay}
                <img src="${product.thumbnailFileName != null ? '/api/image/display/' + product.thumbnailFileName : '/images/default_product.png'}"
                     alt="${product.productName}"
                     class="product-image" />
                <div class="product-info">
                    <h3 onclick="goToProductDetail(${product.productId})">${product.productName}</h3>
                    <p>ì¹´í…Œê³ ë¦¬: ${product.productTag}</p>
                    <div class="product-price">${Number(product.price).toLocaleString()}ì›</div>
                    <button class="add-to-cart-btn" onclick="addToCart(${product.productId}, '${product.productName}')" ${isSoldOut ? 'disabled' : ''}>
                        ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°
                    </button>
                </div>
            `;
            productGrid.appendChild(productCard);
        });
    }

    function goToProductDetail(productId) {
        window.location.href = `/products/${productId}`; // ë˜ëŠ” /product-detail/${productId}
        // ì´ ì£¼ì†Œì— ëŒ€í•œ Controllerì„ ì•ˆë§Œë“¤ì—ˆì–´ìš”
    }

    function addToCart(productId, productName) {
        const payload = {
            productId: productId,
            quantity: 1
        };

        fetch('/api/cart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        })
            .then(res => {
                if (!res.ok) {
                    throw new Error('ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                return res.json();
            })
            .then(data => {
                alert(`ğŸ›’ ${productName}ì´(ê°€) ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                updateCartCount();
                // í•„ìš”ì‹œ UI ì—…ë°ì´íŠ¸ or ì¥ë°”êµ¬ë‹ˆ ìˆ˜ëŸ‰ ê°±ì‹ 
                // updateCartCount();
            })
            .catch(err => {
                console.error(err);
                alert('ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
    }

    function filterByCategory(category) {

        fetch(`/api/products?category=${encodeURIComponent(category)}`)
            .then(response => response.json())
            .then(data => {
                console.log("ğŸ“‚ ì¹´í…Œê³ ë¦¬ ê²°ê³¼:", data);
                displayProducts(data);
            });
    }


    // ì „ì²´ ìƒí’ˆ ë³´ê¸° (home.html)
    function showAllProducts() {
        fetch('/api/products')
            .then(response => response.json())
            .then(data => displayProducts(data));
    }

    // ìƒí’ˆ ê²€ìƒ‰ (home.html)
    function searchProducts() {
        const searchInput = document.getElementById('searchInput');
        const searchTerm = searchInput.value.toLowerCase().trim();
        if (searchTerm === '') {
            fetch('/api/products')
                .then(res => res.json())
                .then(data => displayProducts(data));
            return;
        }

        fetch(`/api/products/search?keyword=${encodeURIComponent(searchTerm)}`)
            .then(response => response.json())
            .then(data => {
                console.log(" ê²€ìƒ‰ ê²°ê³¼ :", data)
                displayProducts(data);
            })
    }
    // ì—”í„° í‚¤ë¡œ ê²€ìƒ‰ (home.htmlì˜ ê²€ìƒ‰ì°½ì—ì„œ ì‚¬ìš©)
    document.addEventListener('keypress', function(event) {
        if (event.key === 'Enter' && event.target.id === 'searchInput') {
            searchProducts();
        }
    });

</script>
<script src="/js/script.js"></script>
</body>
</html>