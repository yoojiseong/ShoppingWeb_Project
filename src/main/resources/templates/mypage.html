<!DOCTYPE html>
<html lang="ko"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fashion Store - ë§ˆì´í˜ì´ì§€</title>
    <link th:href="@{/css/style.css}" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
          crossorigin="anonymous">
</head>
<body>
<header class="header bg-light border-bottom py-3">
    <div class="container d-flex justify-content-between align-items-center">
        <!-- ë¡œê³  -->
        <div class="logo">
            <h1 class="h4 mb-0">
                <a th:href="@{/home}" class="text-decoration-none text-dark">Fashion Store</a>
            </h1>
        </div>

        <!-- ë²„íŠ¼ ì˜ì—­ -->
        <nav class="nav">
            <div class="d-flex gap-3">
                <button class="btn btn-outline-secondary btn-sm" onclick="goToCart()">ğŸ›’ ì¥ë°”êµ¬ë‹ˆ</button>
                <button class="btn btn-outline-danger btn-sm" onclick="logout()" id="logoutBtn">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </nav>
    </div>
</header>

<main class="main">
    <div class="container">
        <div class="mypage-container">
            <h2>ë§ˆì´í˜ì´ì§€</h2>
            <div class="mypage-content">
                <div class="user-info">
                    <h3>íšŒì› ì •ë³´</h3>
                    <div id="userInfo">
                        <!-- ì‚¬ìš©ì ì •ë³´ê°€ JavaScriptë¡œ ë™ì  ìƒì„±ë©ë‹ˆë‹¤ -->
                    </div>
                    <a href="/userInfo-update" class="btn btn-primary edit-btn">ì •ë³´ ìˆ˜ì •</a>
                </div>
                <div class="order-history">
                    <h3>ì£¼ë¬¸ ë‚´ì—­</h3>
                    <div id="orderHistory">
                        <!-- ì£¼ë¬¸ ë‚´ì—­ì´ JavaScriptë¡œ ë™ì  ìƒì„±ë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script th:src="@{/js/script.js}"></script>
<script>
    function displayUserInfo() {
        fetch('/api/members/me', {credentials: 'include'})
            .then(res => {
                if (res.status === 401) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = '/login';
                    return;
                }
                if (!res.ok) throw new Error('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return res.json();
            })
            .then(user => {
                if (!user) return;
                const userInfo = document.getElementById('userInfo');
                if (!userInfo) return;
                userInfo.innerHTML = `
            <div class="user-detail"><strong>ì´ë¦„:</strong> ${user.userName}</div>
            <div class="user-detail"><strong>ì´ë©”ì¼:</strong> ${user.email}</div>
            <div class="user-detail"><strong>ì „í™”ë²ˆí˜¸:</strong> ${user.phone}</div>
            <div class="user-detail"><strong>ìƒì¼:</strong>${user.birthDate ? new Date(user.birthDate).toLocaleDateString() : 'ë¯¸ë“±ë¡'}</div>
        `;
            })
            .catch(err => {
                console.error(err);
                alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
    }

    // ì£¼ë¬¸ ë‚´ì—­ í‘œì‹œ (mypage.html)
    function displayOrderHistory() {
        fetch('/api/orders', {credentials: 'include'})
            .then(res => {
                if (res.status === 401) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = '/login';
                    return;
                }
                if (!res.ok) throw new Error('ì£¼ë¬¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return res.json();
            })
            .then(orders => {
                if (!orders) return;
                const orderHistory = document.getElementById('orderHistory');
                if (!orderHistory) return;
                if (orders.length === 0) {
                    orderHistory.innerHTML = '<p>ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }
                orderHistory.innerHTML = '';
                orders.reverse().forEach(order => {
                    const orderItem = document.createElement('div');
                    orderItem.className = 'order-item';
                    const itemList = order.orderItems.map(item => `${item.productName} x ${item.quantity}`).join(', ');
                    orderItem.innerHTML = `
                <div class="order-date">ì£¼ë¬¸ì¼: ${new Date(order.orderDate).toLocaleDateString()}</div>
                <div class="order-items">${itemList}</div>
                <div class="order-total">ì´ ê¸ˆì•¡: ${order.totalPrice.toLocaleString()}ì›</div>
                <div class="order-address">ë°°ì†¡ì§€ : ${order.address},${order.addressDetail}</div>
            `;
                    orderHistory.appendChild(orderItem);
                });
            })
            .catch(err => {
                console.error(err);
                alert('ì£¼ë¬¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
    }

    // í˜ì´ì§€ ë¡œë”© ì‹œ ì‚¬ìš©ì ì •ë³´ ë° ì£¼ë¬¸ ë‚´ì—­ í‘œì‹œ
    document.addEventListener('DOMContentLoaded', () => {
        displayUserInfo();
        displayOrderHistory();
    });


    // ====================================================================================================
    // ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜ë“¤ (ëª¨ë“  HTML í˜ì´ì§€ì˜ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ì—ì„œ ì‚¬ìš©)
    // ====================================================================================================

</script>
</body>
</html>