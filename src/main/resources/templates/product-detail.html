<!DOCTYPE html>
<html lang="ko"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fashion Store - ìƒí’ˆ ìƒì„¸</title>
    <link th:href="@{/css/style.css}" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
          crossorigin="anonymous">
</head>
<body>
<header class="header">
    <div class="container">
        <div class="logo">
            <h1><a th:href="@{/home}">Fashion Store</a></h1>
        </div>
        <nav class="nav">
            <div class="nav-buttons">
                <button onclick="goToMyPage()">ë§ˆì´í˜ì´ì§€</button>
                <button onclick="goToCart()">ì¥ë°”êµ¬ë‹ˆ (<span id="cartCount">0</span>)</button>
                <button onclick="goToLogin()" id="loginBtn">ë¡œê·¸ì¸</button>
                <button onclick="logout()" id="logoutBtn" style="display: none;">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </nav>
    </div>
</header>

<main class="main">
    <div class="container">
        <!-- ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
        <button class="back-btn" onclick="goBack()">
            â† ìƒí’ˆ ëª©ë¡ìœ¼ë¡œ
        </button>

        <!-- ìƒí’ˆ ìƒì„¸ ì •ë³´ -->
        <div class="product-detail-container">
            <div class="product-detail-grid">
                <!-- ìƒí’ˆ ì´ë¯¸ì§€ -->
                <div class="product-image-large" id="productImageLarge">
                    <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                </div>

                <!-- ìƒí’ˆ ì •ë³´ -->
                <div class="product-info-detail">
                    <div class="product-category" id="productCategory"></div>
                    <h1 class="product-title" id="productTitle"></h1>
                    <div class="product-price-large" id="productPriceLarge"></div>

                    <!-- í‰ì  ì •ë³´ -->
                    <div class="rating-info">
                        <div class="stars" id="averageStars"></div>
                        <span class="rating-score" id="averageRating">0.0</span>
                        <span class="review-count" id="reviewCount">(0ê°œ ë¦¬ë·°)</span>
                    </div>

                    <!-- ìƒí’ˆ ì„¤ëª… -->
                    <div class="product-description">
                        <h3>ìƒí’ˆ ì„¤ëª…</h3>
                        <p id="productDescription"></p>
                    </div>

                    <!-- êµ¬ë§¤ ë²„íŠ¼ -->
                    <button class="add-to-cart-btn-large" onclick="addToCartFromDetail()">
                        ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°
                    </button>
                </div>
            </div>
        </div>

        <!-- ë¦¬ë·° ì„¹ì…˜ -->
        <div class="review-section">
            <h2>ìƒí’ˆ ë¦¬ë·°</h2>

            <!-- ë¦¬ë·° ì‘ì„± -->
            <div class="review-write-container" id="reviewWriteContainer">
                <div class="review-write-card">
                    <h3>ë¦¬ë·° ì‘ì„±</h3>
                    <form id="reviewForm" onsubmit="submitReview(event)">
                        <div class="form-group">
                            <label>í‰ì </label>
                            <div class="star-rating" id="starRating">
                                <span class="star" data-rating="1">â˜…</span>
                                <span class="star" data-rating="2">â˜…</span>
                                <span class="star" data-rating="3">â˜…</span>
                                <span class="star" data-rating="4">â˜…</span>
                                <span class="star" data-rating="5">â˜…</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>ë¦¬ë·° ë‚´ìš©</label>
                            <textarea id="reviewComment" placeholder="ìƒí’ˆì— ëŒ€í•œ ì†”ì§í•œ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”." rows="4" required></textarea>
                        </div>
                        <button type="submit" class="submit-review-btn">ë¦¬ë·° ë“±ë¡</button>
                    </form>
                </div>
            </div>

            <!-- ë¡œê·¸ì¸ í•„ìš” ë©”ì‹œì§€ -->

                 <div class="login-required" id="loginRequired" style="display: none;">
                    <div class="login-required-card">
                        <p>ë¦¬ë·°ë¥¼ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                        <button onclick="goToLogin()">ë¡œê·¸ì¸í•˜ê¸°</button>
                    </div>
                 </div>


            <!-- ë¦¬ë·° ëª©ë¡ -->
            <div class="review-list" id="reviewList">
                <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
            </div>
        </div>
    </div>
</main>

<script th:src="@{/js/script.js}"></script>
<script>
    let currentProduct = null;
    window.onload = initializeProductDetail;
    // const urlParams = new URLSearchParams(window.location.search);
    // const pproductId = urlPParams.get('id');
    // fetch(`/api/products/${pproductId}`)
    //     .then(res => res.json())
    //     .then(product => {
    //         document.getElementById('productName').textContent = product.productName;
    //     })

    // ë’¤ë¡œê°€ê¸° (product-detail.html)
    function goBack() {
        window.location.href = '/home';
    }

    // ìƒí’ˆ ìƒì„¸ í˜ì´ì§€ ì´ˆê¸°í™” (product-detail.html)
    function initializeProductDetail() {
        // const params = new URLSearchParams(window.location.search);
        // const productId = params.get('id');
        const pathSegments = window.location.pathname.split('/');
        const productId = pathSegments[pathSegments.length - 1];
        if (!productId) {
            window.location.href = '/home';
            return;
        }

        fetch(`/api/products/${productId}`) //productDTO
            .then(res => {
                if (!res.ok) throw new Error('ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                return res.json();
            })
            .then(product => {
                currentProduct = product;
                displayProductDetail(product);
                updateProductRating(product.productId); // ë¦¬ë·°ìª½ì€ ì¶”í›„ ì—°ê²°
                displayProductReviews(product.productId);
                initializeReviewForm();
                updateCartCount();
            })
            .catch(err => {
                alert(err.message);
                window.location.href = '/';
            });
    }

    // ìƒí’ˆ ìƒì„¸ ì •ë³´ í‘œì‹œ (product-detail.html)
    function displayProductDetail(product) {
        document.getElementById('productImageLarge').textContent = product.image;
        document.getElementById('productCategory').textContent = product.productTag;
        document.getElementById('productTitle').textContent = product.productName;
        document.getElementById('productPriceLarge').textContent = Number(product.price).toLocaleString() + 'ì›';
        // ìƒí’ˆ ì„¤ëª… ì„¤ì •
        const descriptions = {
            'ë°”ì§€': 'í¸ì•ˆí•œ ì°©ìš©ê°ê³¼ ìŠ¤íƒ€ì¼ì„ ë™ì‹œì— ë§Œì¡±ì‹œí‚¤ëŠ” ë°”ì§€ì…ë‹ˆë‹¤. ë‹¤ì–‘í•œ ìƒí™©ì—ì„œ í™œìš©í•  ìˆ˜ ìˆëŠ” ë² ì´ì§í•œ ë””ìì¸ìœ¼ë¡œ ì œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.',
            'ì‹ ë°œ': 'ë°œì˜ í¸ì•ˆí•¨ì„ ìµœìš°ì„ ìœ¼ë¡œ ê³ ë ¤í•œ ì‹ ë°œì…ë‹ˆë‹¤. ê³ í’ˆì§ˆ ì†Œì¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ë‚´êµ¬ì„±ê³¼ ìŠ¤íƒ€ì¼ì„ ëª¨ë‘ ê°–ì¶”ì—ˆìŠµë‹ˆë‹¤.',
            'ìƒì˜': 'ë¶€ë“œëŸ¬ìš´ ì†Œì¬ì™€ ì„¸ë ¨ëœ ë””ìì¸ì´ íŠ¹ì§•ì¸ ìƒì˜ì…ë‹ˆë‹¤. ì¼ìƒë³µìœ¼ë¡œë„, ì™¸ì¶œë³µìœ¼ë¡œë„ ì™„ë²½í•œ ì•„ì´í…œì…ë‹ˆë‹¤.',
            'ì•„ìš°í„°': 'ì¶”ìš´ ë‚ ì”¨ì—ë„ ë”°ëœ»í•¨ì„ ìœ ì§€í•´ì£¼ëŠ” ì•„ìš°í„°ì…ë‹ˆë‹¤. ì‹¤ìš©ì„±ê³¼ íŒ¨ì…˜ì„±ì„ ëª¨ë‘ ê³ ë ¤í•œ ë””ìì¸ì…ë‹ˆë‹¤.'
        };
        document.getElementById('productDescription').textContent = descriptions[product.category] || 'ê³ í’ˆì§ˆ ìƒí’ˆì…ë‹ˆë‹¤.';
        // í‰ì  ì •ë³´ ì—…ë°ì´íŠ¸
        updateProductRating(product.id);
    }


    // ìƒí’ˆ í‰ì  ì •ë³´ ì—…ë°ì´íŠ¸ (product-detail.html)
    function updateProductRating(productId) {
        const productReviews = reviews.filter(review => review.productId === productId);
        const averageRating = productReviews.length > 0
            ? productReviews.reduce((sum, review) => sum + review.rating, 0) / productReviews.length
            : 0;
        const starsContainer = document.getElementById('averageStars');
        const ratingScore = document.getElementById('averageRating');
        const reviewCount = document.getElementById('reviewCount');
        starsContainer.innerHTML = renderStars(Math.round(averageRating));
        ratingScore.textContent = averageRating.toFixed(1);
        reviewCount.textContent = `(${productReviews.length}ê°œ ë¦¬ë·°)`;
    }

    // ë³„ì  ë Œë”ë§ (product-detail.html)
    function renderStars(rating) {
        let starsHTML = '';
        for (let i = 1; i <= 5; i++) {
            if (i <= rating) {
                starsHTML += '<span class="star">â˜…</span>';
            } else {
                starsHTML += '<span class="star empty">â˜…</span>';
            }
        }
        return starsHTML;
    }

    // ìƒí’ˆ ë¦¬ë·° í‘œì‹œ (product-detail.html)
    function displayProductReviews(productId) {
        const productReviews = reviews.filter(review => review.productId === productId);
        const reviewList = document.getElementById('reviewList');
        if (productReviews.length === 0) {
            reviewList.innerHTML = `
            <div class="no-reviews">
                <p>ì•„ì§ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ë¦¬ë·°ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
            </div>
        `;
            return;
        }
        reviewList.innerHTML = '';
        productReviews.slice().reverse().forEach(review => {
            const reviewItem = document.createElement('div');
            reviewItem.className = 'review-item';
            reviewItem.innerHTML = `
            <div class="review-header">
                <div class="review-user-info">
                    <div class="review-user-name">${review.userName}</div>
                    <div class="review-date">${review.date}</div>
                </div>
                <div class="review-rating">${renderStars(review.rating)}</div>
            </div>
            <div class="review-comment">${review.comment}</div>
        `;
            reviewList.appendChild(reviewItem);
        });
    }

    // ë¦¬ë·° í¼ ì´ˆê¸°í™” (product-detail.html)
    function initializeReviewForm() {
        const reviewWriteContainer = document.getElementById('reviewWriteContainer');
        const loginRequired = document.getElementById('loginRequired');
        if (currentUser) {
            reviewWriteContainer.style.display = 'block';
            loginRequired.style.display = 'none';
            // ë³„ì  í´ë¦­ ì´ë²¤íŠ¸ ì„¤ì •
            const stars = document.querySelectorAll('.star-rating .star');
            stars.forEach((star, index) => {
                star.addEventListener('click', () => {
                    selectedRating = index + 1;
                    updateStarRating();
                });
                star.addEventListener('mouseover', () => {
                    highlightStars(index + 1);
                });
            });
            document.querySelector('.star-rating').addEventListener('mouseleave', () => {
                updateStarRating();
            });
            updateStarRating();
        } else {
            reviewWriteContainer.style.display = 'none';
            loginRequired.style.display = 'block';
        }
    }

    // ë³„ì  ì—…ë°ì´íŠ¸ (product-detail.html)
    function updateStarRating() {
        const stars = document.querySelectorAll('.star-rating .star');
        stars.forEach((star, index) => {
            if (index < selectedRating) {
                star.classList.add('active');
            } else {
                star.classList.remove('active');
            }
        });
    }

    // ë³„ì  í•˜ì´ë¼ì´íŠ¸ (product-detail.html)
    function highlightStars(rating) {
        const stars = document.querySelectorAll('.star-rating .star');
        stars.forEach((star, index) => {
            if (index < rating) {
                star.classList.add('active');
            } else {
                star.classList.remove('active');
            }
        });
    }

    // ë¦¬ë·° ì œì¶œ (product-detail.html)
    function submitReview(event) {
        event.preventDefault();
        if (!currentUser) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            return;
        }
        const productId = parseInt(localStorage.getItem('selectedProductId'));
        const comment = document.getElementById('reviewComment').value.trim();
        if (!comment) {
            alert('ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        const newReview = {
            id: Date.now(),
            productId: productId,
            userId: currentUser.email,
            userName: currentUser.name,
            rating: selectedRating,
            comment: comment,
            date: new Date().toLocaleDateString()
        };
        reviews.push(newReview);
        localStorage.setItem('reviews', JSON.stringify(reviews));
        // í¼ ì´ˆê¸°í™”
        document.getElementById('reviewComment').value = '';
        selectedRating = 5;
        updateStarRating();
        // ë¦¬ë·° ëª©ë¡ ë° í‰ì  ì—…ë°ì´íŠ¸
        displayProductReviews(productId);
        updateProductRating(productId);
        alert('ë¦¬ë·°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    // ìƒì„¸ í˜ì´ì§€ì—ì„œ ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° (product-detail.html)
    function addToCartFromDetail() {
        const pathParts = window.location.pathname.split('/');
        const productId = pathParts[pathParts.length - 1];
        addToCart(currentProduct.productId , currentProduct.productName);
    }

    function addToCart(productId, productName) {
        const payload = {
            productId: productId,
            quantity: 1
        };

        fetch('/api/cart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        })
            .then(res => {
                if (!res.ok) {
                    throw new Error('ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                return res.json();
            })
            .then(data => {
                alert(`ğŸ›’ ${productName}ì´(ê°€) ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                updateCartCount();
                // í•„ìš”ì‹œ UI ì—…ë°ì´íŠ¸ or ì¥ë°”êµ¬ë‹ˆ ìˆ˜ëŸ‰ ê°±ì‹ 
                // updateCartCount();
            })
            .catch(err => {
                console.error(err);

            });
    }
    function updateCartCount() {
        fetch('/api/cart')
            .then(res => {
                if (!res.ok) throw new Error('ì¥ë°”êµ¬ë‹ˆ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
                return res.json();
            })
            .then(data => {
                const count = data.length;
                document.getElementById('cartCount').textContent = count;
            })
            .catch(err => {
                console.error(err);
                // ì˜¤ë¥˜ ì‹œ 0ìœ¼ë¡œ ì„¤ì •
                document.getElementById('cartCount').textContent = 0;
            });
    }
</script>
</body>
</html>