<!DOCTYPE html>
<html lang="ko"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fashion Store - ìƒí’ˆ ìƒì„¸</title>
    <link th:href="@{/css/style.css}" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
          crossorigin="anonymous">
</head>
<body>
<header class="header bg-light border-bottom py-3">
    <div class="container d-flex justify-content-between align-items-center">
        <!-- ë¡œê³  -->
        <div class="logo">
            <h1 class="h4 mb-0">
                <a th:href="@{/home}" class="text-decoration-none text-dark">Fashion Store</a>
            </h1>
        </div>

        <!-- ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ -->
        <nav class="nav">
            <div class="d-flex align-items-center gap-3">

                <button class="btn btn-outline-primary btn-sm" onclick="goToMyPage()">ë§ˆì´í˜ì´ì§€</button>
                <button class="btn btn-outline-success btn-sm" onclick="goToCart()">
                    ì¥ë°”êµ¬ë‹ˆ (<span id="cartCount">0</span>)
                </button>

                <!-- ë¡œê·¸ì¸ ì‚¬ìš©ììš© -->
                <div sec:authorize="isAuthenticated()" class="d-flex align-items-center gap-2">
                    <span class="text-muted small" sec:authentication="name">ì‚¬ìš©ì ì´ë©”ì¼</span>
                    <a href="/logout" class="btn btn-outline-danger btn-sm">ë¡œê·¸ì•„ì›ƒ</a>
                </div>

                <!-- ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ììš© -->
                <div sec:authorize="!isAuthenticated()" class="d-flex align-items-center gap-2">
                    <button class="btn btn-outline-secondary btn-sm" onclick="goToLogin()" id="loginBtn">ë¡œê·¸ì¸</button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="goToSignup()">íšŒì›ê°€ì…</button>
                </div>

            </div>
        </nav>
    </div>
</header>

    <main class="main">
        <div class="container">
            <!-- ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
            <button class="back-btn" onclick="goBack()">
                â† ìƒí’ˆ ëª©ë¡ìœ¼ë¡œ
            </button>

            <!-- ìƒí’ˆ ìƒì„¸ ì •ë³´ -->
            <div class="product-detail-container">
                <div class="product-detail-grid">
                    <!-- ìƒí’ˆ ì´ë¯¸ì§€ -->
                    <div class="product-image-large" id="productImageLarge">
                        <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                    </div>

                    <!-- ìƒí’ˆ ì •ë³´ -->
                    <div class="product-info-detail">
                        <div class="product-category" id="productCategory"></div>
                        <h1 class="product-title" id="productTitle"></h1>
                        <div class="product-price-large" id="productPriceLarge"></div>

                        <!-- í‰ì  ì •ë³´ -->
                        <div class="rating-info">
                            <div class="stars" id="averageStars"></div>
                            <span class="rating-score" id="averageRating">0.0</span>
                            <span class="review-count" id="reviewCount">(0ê°œ ë¦¬ë·°)</span>
                        </div>

                        <!-- ìƒí’ˆ ì„¤ëª… -->
                        <div class="product-description">
                            <h3>ìƒí’ˆ ì„¤ëª…</h3>
                            <p id="productDescription"></p>
                        </div>

                        <!-- êµ¬ë§¤ ë²„íŠ¼ -->
                        <button class="add-to-cart-btn-large" onclick="addToCartFromDetail()">
                            ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°
                        </button>
                    </div>
                </div>
            </div>

            <!-- ì œí’ˆ ìƒì„¸ ì´ë¯¸ì§€ íŒŒíŠ¸ -->
            <div class="product-detail-images" id="productDetailImages" style="display: flex; gap: 10px; margin-bottom: 20px;">
                <!-- ìƒì„¸ ì´ë¯¸ì§€ë“¤ì´ ì—¬ê¸°ì— ë“¤ì–´ê°‘ë‹ˆë‹¤ -->
            </div>

            <!-- ë¦¬ë·° ì„¹ì…˜ -->
            <div class="review-section">
                <h2>ìƒí’ˆ ë¦¬ë·°</h2>

                <!-- ë¦¬ë·° ì‘ì„± -->
                <div class="review-write-container" id="reviewWriteContainer" style="display: none;">
                    <div class="review-write-card">
                        <h3>ë¦¬ë·° ì‘ì„±</h3>
                        <form id="reviewForm" onsubmit="submitReview(event)">
                            <div class="form-group">
                                <label>í‰ì </label>
                                <div class="star-rating" id="starRating">
                                    <span class="star" data-rating="1">â˜…</span>
                                    <span class="star" data-rating="2">â˜…</span>
                                    <span class="star" data-rating="3">â˜…</span>
                                    <span class="star" data-rating="4">â˜…</span>
                                    <span class="star" data-rating="5">â˜…</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>ë¦¬ë·° ë‚´ìš©</label>
                                <textarea id="reviewComment" placeholder="ìƒí’ˆì— ëŒ€í•œ ì†”ì§í•œ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”." rows="4"
                                    required></textarea>
                            </div>
                            <button type="submit" class="submit-review-btn">ë¦¬ë·° ë“±ë¡</button>
                        </form>
                    </div>
                </div>

                <!-- ë¡œê·¸ì¸ í•„ìš” ë©”ì‹œì§€ -->

                <div class="login-required" id="loginRequired" style="display: none;">
                    <div class="login-required-card">
                        <p>ë¦¬ë·°ë¥¼ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                        <button onclick="goToLogin()">ë¡œê·¸ì¸í•˜ê¸°</button>
                    </div>
                </div>


                <!-- ë¦¬ë·° ëª©ë¡ -->
                <div class="review-list" id="reviewList">

                </div>

<!--                ë¦¬ë·° í˜ì´ì§• ì˜ì—­-->
                <div class="review-pagination" id="reviewPagination" style="margin-top: 1rem;"></div>
            </div>
        </div>
    </main>

    <script th:src="@{/js/script.js}"></script>
    <script>
        let currentUser = null;
        let purchase = false;
        let currentProduct = null;
        let isEditMode = false;
        editingReviewId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            await fetchCurrentUser();         // currentUser ë¨¼ì € ì„¸íŒ…
            initializeProductDetail();// ìƒì„¸ í˜ì´ì§€ í‘œì‹œ

        });

        async function fetchCurrentUser() {
            try {
                const res = await fetch('/api/members/me', {
                    credentials: 'include'
                });
                if (!res.ok) throw new Error('ë¡œê·¸ì¸ ì•ˆë¨');
                currentUser = await res.json();
                console.log('ë¡œê·¸ì¸ ì‚¬ìš©ì:', currentUser);
            } catch (err) {
                console.warn('ë¹„ë¡œê·¸ì¸ ìƒíƒœ', err);
                currentUser = null;
            }
        }


        // ë’¤ë¡œê°€ê¸° (product-detail.html)
        function goBack() {
            window.location.href = '/home';
        }

        // ìƒí’ˆ ìƒì„¸ í˜ì´ì§€ ì´ˆê¸°í™” (product-detail.html)
        async function initializeProductDetail() {
            const pathSegments = window.location.pathname.split('/');
            const productId = pathSegments[pathSegments.length - 1];

            if (!productId) {
                window.location.href = '/home';
                return;
            }

            try {
                const res = await fetch(`/api/products/${productId}`);
                if (!res.ok) throw new Error('ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');

                const product = await res.json();
                console.log("product : ", product);
                currentProduct = product;
                initializeReviewForm(currentProduct.productId);

                displayProductDetail(product);
                updateCartCount();
                await fetchReviews(productId , 1);
            } catch (err) {
                alert(err.message);
                window.location.href = '/';
            }
        }

        // ìƒí’ˆ ìƒì„¸ ì •ë³´ í‘œì‹œ (product-detail.html)
        function displayProductDetail(product) {
            const productImageLarge = document.getElementById('productImageLarge');
            const imageUrl = product.thumbnailFileName != null ? '/api/image/display/' + product.thumbnailFileName : '/images/default_product.png';
            productImageLarge.innerHTML = `<img src="${imageUrl}" alt="${product.productName}">`;
            document.getElementById('productCategory').textContent = product.productTag;
            document.getElementById('productTitle').textContent = product.productName;
            document.getElementById('productPriceLarge').textContent = Number(product.price).toLocaleString() + 'ì›';
            // ìƒí’ˆ ì„¤ëª… ì„¤ì •
            const descriptions = {
                'ë°”ì§€': 'í¸ì•ˆí•œ ì°©ìš©ê°ê³¼ ìŠ¤íƒ€ì¼ì„ ë™ì‹œì— ë§Œì¡±ì‹œí‚¤ëŠ” ë°”ì§€ì…ë‹ˆë‹¤. ë‹¤ì–‘í•œ ìƒí™©ì—ì„œ í™œìš©í•  ìˆ˜ ìˆëŠ” ë² ì´ì§í•œ ë””ìì¸ìœ¼ë¡œ ì œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.',
                'ì‹ ë°œ': 'ë°œì˜ í¸ì•ˆí•¨ì„ ìµœìš°ì„ ìœ¼ë¡œ ê³ ë ¤í•œ ì‹ ë°œì…ë‹ˆë‹¤. ê³ í’ˆì§ˆ ì†Œì¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ë‚´êµ¬ì„±ê³¼ ìŠ¤íƒ€ì¼ì„ ëª¨ë‘ ê°–ì¶”ì—ˆìŠµë‹ˆë‹¤.',
                'ìƒì˜': 'ë¶€ë“œëŸ¬ìš´ ì†Œì¬ì™€ ì„¸ë ¨ëœ ë””ìì¸ì´ íŠ¹ì§•ì¸ ìƒì˜ì…ë‹ˆë‹¤. ì¼ìƒë³µìœ¼ë¡œë„, ì™¸ì¶œë³µìœ¼ë¡œë„ ì™„ë²½í•œ ì•„ì´í…œì…ë‹ˆë‹¤.',
                'ì•„ìš°í„°': 'ì¶”ìš´ ë‚ ì”¨ì—ë„ ë”°ëœ»í•¨ì„ ìœ ì§€í•´ì£¼ëŠ” ì•„ìš°í„°ì…ë‹ˆë‹¤. ì‹¤ìš©ì„±ê³¼ íŒ¨ì…˜ì„±ì„ ëª¨ë‘ ê³ ë ¤í•œ ë””ìì¸ì…ë‹ˆë‹¤.'
            };
            document.getElementById('productDescription').textContent = descriptions[product.category] || 'ê³ í’ˆì§ˆ ìƒí’ˆì…ë‹ˆë‹¤.';

            const container = document.getElementById('productDetailImages');
            container.innerHTML = '';  // ê¸°ì¡´ ë‚´ìš© ë¹„ìš°ê¸°
            console.log("fileNames í™•ì¸:", product.fileNames);
            if (!product.fileNames || product.fileNames.length === 0) {
                container.innerHTML = '<p>ìƒì„¸ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            product.fileNames.forEach(fileName => {
                const img = document.createElement('img');
                img.src = `/api/image/display/${fileName}`;
                img.alt = 'ì œí’ˆ ìƒì„¸ ì´ë¯¸ì§€';
                img.addEventListener('click', () => {
                    // í´ë¦­ ì‹œ í° ì´ë¯¸ì§€ ë³´ì—¬ì£¼ê¸° ë“± ì¶”ê°€ ê¸°ëŠ¥ ê°€ëŠ¥
                    alert('ì´ë¯¸ì§€ í´ë¦­ë¨: ' + fileName);
                });
                container.appendChild(img);
            });
            console.log("ìƒí’ˆ í‰ì  ë³´ê¸° : ", product);
            // í‰ì  ì •ë³´ ì—…ë°ì´íŠ¸
            updateProductRating(product);
        }


        // ìƒí’ˆ í‰ì  ì •ë³´ ì—…ë°ì´íŠ¸ (product-detail.html)
        function updateProductRating(product) {
            if(product.rating === null){
                document.getElementById('averageStars').innerHTML = renderStars(0);
                document.getElementById('averageRating').textContent = '0.0';
                document.getElementById('reviewCount').textContent = '(0ê°œ ë¦¬ë·°)';
                return;
            }

            document.getElementById('averageStars').innerHTML = renderStars(Math.round(product.avgRate));
            document.getElementById('averageRating').textContent = product.avgRate;
            document.getElementById('reviewCount').textContent = `(${product.rateCount}ê°œ ë¦¬ë·°)`;
        }

        // ë³„ì  ë Œë”ë§ (product-detail.html)
        function renderStars(rating) {
            let starsHTML = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    starsHTML += '<span class="star">â˜…</span>';
                } else {
                    starsHTML += '<span class="star empty">â˜…</span>';
                }
            }
            return starsHTML;
        }
        // ==================================================================================================
        let selecteRating = 5;

        // ë¦¬ë·° ë¶ˆëŸ¬ì˜¤ê¸° ê¸°ëŠ¥
        async function fetchReviews(productId , page){
            console.log("fetchReviews í˜¸ì¶œ ë¨, productId",productId);
            const res = await fetch(`/api/reviews?productId=${productId}&page=${page}&size=10`);
            console.log("resë¡œ ë°›ì•„ì˜¨ ë°ì´í„° í™•ì¸",res);
            if(!res.ok){
                alert('ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                return;
            }
            const result = await res.json();
            console.log("result.dtoList", result.dtoList);
            //dtoList => ì²« ë²ˆì§¸ í˜ì´ì§€ ë¦¬ë·° ëª©ë¡
            displayProductReviews(result.dtoList);
            if (result.dtoList.length > 0 && result.dtoList[0].productId) {
                updateReviewPagination(result, result.dtoList[0].productId);

            } else {
                updateReviewPagination(result, productId);
            }
        }

        // ë¦¬ë·° ë Œë”ë§
        function displayProductReviews(reviews){
            console.log("displayProductReviews í˜¸ì¶œ ë¨");
            const reviewList = document.getElementById('reviewList');
            console.log("ëƒê¸€ ëª©ë¡ ë³´ê¸° : ", reviews);
            reviewList.innerHTML = '';

            if(!reviews || reviews.length === 0){
                reviewList.innerHTML = '<p>ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤. </p>';
                return;
            }

            reviews.forEach(review => {
                console.log("í˜„ì¬ ìœ ì € : ", currentUser.id);
                console.log("ë¦¬ë·° ì‘ì„±ì ìœ ì € : ", review.memberId);
                let isOwner = false;
                if(currentUser.id === review.memberId){
                    isOwner = true;
                }
                const item = document.createElement('div');
                item.className = 'review-item';
                item.innerHTML=`
               <div class="review-header">
                    <strong>${review.memberName}</strong> | <span>${review.createdAt}</span>
                    <div>${renderStars(review.rating)}</div>
                    ${isOwner ? `<button class="btn btn-sm btn-outline-primary edit-review-btn" data-id="${review.reviewId}">âœï¸ ìˆ˜ì •</button>` : ''}
                </div>
            <p>${review.reviewContent}</p>
        `;
                reviewList.appendChild(item);
            })
            // ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²°
            document.querySelectorAll('.edit-review-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const reviewId = parseInt(e.target.getAttribute('data-id'));
                    const review = reviews.find(r => r.reviewId === reviewId);
                    if (review) {
                        enterEditMode(review);
                    }
                });
            });
        }

        function enterEditMode(review) {
            isEditMode = true;
            editingReviewId = review.reviewId;

            document.getElementById('reviewWriteContainer').style.display = 'block';
            document.getElementById('reviewComment').value = review.reviewContent;

            // ë³„ì ë„ ê¸°ì¡´ ê±¸ë¡œ ì„¸íŒ…
            document.querySelectorAll('#starRating .star').forEach(star => {
                const rating = parseInt(star.dataset.rating);
                star.classList.toggle('selected', rating <= review.rating);
            });

            selectedRating = review.rating;
        }

        function updateReviewPagination(pageData, productId){
            const container = document.getElementById('reviewPagination');
            console.log('í˜ì´ì§€ë„¤ì´ì…˜ ë°ì´í„°:', pageData);
            container.innerHTML = '';

            // 'ì´ì „' ë²„íŠ¼ ì¶”ê°€
            if (pageData.prev) {
                const prevBtn = document.createElement('button');
                prevBtn.textContent = 'ì´ì „';
                prevBtn.className = 'btn btn-outline-secondary btn-sm';
                prevBtn.addEventListener('click', () => fetchReviews(productId, pageData.start - 1));
                container.appendChild(prevBtn);
            }

            for(let i = pageData.start; i <= pageData.end; i++){
                const btn = document.createElement('button');
                btn.textContent = i;
                btn.className = i === pageData.page ? 'active btn btn-primary btn-sm' : 'btn btn-outline-secondary btn-sm';
                btn.addEventListener('click', () => fetchReviews(productId, i));
                container.appendChild(btn);
            }

            // 'ë‹¤ìŒ' ë²„íŠ¼ ì¶”ê°€
            if (pageData.next) {
                const nextBtn = document.createElement('button');
                nextBtn.textContent = 'ë‹¤ìŒ';
                nextBtn.className = 'btn btn-outline-secondary btn-sm';
                nextBtn.addEventListener('click', () => fetchReviews(productId, pageData.end + 1));
                container.appendChild(nextBtn);
            }
        }
        // ==================================================================================================

        // ==================================================================================================




        // ë³„ì  ì—…ë°ì´íŠ¸ (product-detail.html)
        function updateStarRating() {
            const stars = document.querySelectorAll('.star-rating .star');
            stars.forEach((star, index) => {
                if (index < selectedRating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        // ë³„ì  í•˜ì´ë¼ì´íŠ¸ (product-detail.html)
        function highlightStars(rating) {
            const stars = document.querySelectorAll('.star-rating .star');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }


        // ìƒì„¸ í˜ì´ì§€ì—ì„œ ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° (product-detail.html)
        function addToCartFromDetail() {
            const pathParts = window.location.pathname.split('/');
            const productId = pathParts[pathParts.length - 1];
            addToCart(currentProduct.productId, currentProduct.productName);
        }

        function addToCart(productId, productName) {
            const payload = {
                productId: productId,
                quantity: 1
            };

            fetch('/api/cart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
                .then(res => {
                    if (!res.ok) {
                        throw new Error('ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                    return res.json();
                })
                .then(data => {
                    alert(`ğŸ›’ ${productName}ì´(ê°€) ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    updateCartCount();
                    // í•„ìš”ì‹œ UI ì—…ë°ì´íŠ¸ or ì¥ë°”êµ¬ë‹ˆ ìˆ˜ëŸ‰ ê°±ì‹ 
                    // updateCartCount();
                })
                .catch(err => {
                    console.error(err);

                });
        }
        function updateCartCount() {
            fetch('/api/cart')
                .then(res => {
                    if (!res.ok) throw new Error('ì¥ë°”êµ¬ë‹ˆ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
                    return res.json();
                })
                .then(data => {
                    const count = data.length;
                    document.getElementById('cartCount').textContent = count;
                })
                .catch(err => {
                    console.error(err);
                    // ì˜¤ë¥˜ ì‹œ 0ìœ¼ë¡œ ì„¤ì •
                    document.getElementById('cartCount').textContent = 0;
                });
        }

        // â­ ë³„ì  ì„ íƒ ì´ë²¤íŠ¸ ì„¤ì •
        document.querySelectorAll('.star-rating .star').forEach(star => {
            star.addEventListener('click', () => {
                selectedRating = parseInt(star.dataset.rating);
                updateStarUI(selectedRating);
            });
        });

        function updateStarUI(rating) {
            document.querySelectorAll('.star-rating .star').forEach(star => {
                star.style.color = parseInt(star.dataset.rating) <= rating ? '#ffc107' : '#ccc';
            });
        }

        // âœ… ë¦¬ë·° ë“±ë¡ í•¨ìˆ˜
        async function submitReview(event) {
            event.preventDefault();

            const comment = document.getElementById('reviewComment').value;

            if (!selectedRating || selectedRating < 1 || selectedRating > 5) {
                alert("ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            const reviewData = {
                rating: selectedRating,
                reviewContent: comment,
                productId: currentProduct.productId
            };

            if (isEditMode) {
                // ìˆ˜ì • ìš”ì²­
                const res = await fetch(`/api/reviews/${editingReviewId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(reviewData),
                    credentials: 'include'
                });

                if (res.ok) {
                    alert('ë¦¬ë·°ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    alert('ë¦¬ë·° ìˆ˜ì • ì‹¤íŒ¨');
                }

            } else {
                console.log("ë¦¬ë·° ë“±ë¡ í•˜ê² ìŠµë‹ˆë‹¤.");
                // ì‹ ê·œ ë“±ë¡
                const res = await fetch('/api/reviews', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(reviewData),
                    credentials: 'include'
                });

                if (res.ok) {
                    alert('ë¦¬ë·°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    alert('ë¦¬ë·° ë“±ë¡ ì‹¤íŒ¨');
                }
            }

            // ì´ˆê¸°í™”
            isEditMode = false;
            editingReviewId = null;
            document.getElementById('reviewForm').reset();
            document.getElementById('reviewWriteContainer').style.display = 'none';

            // ë¦¬ë·° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
            await fetchReviews(currentProduct.productId, 1);
        }


        async function initializeReviewForm(productId) {
            const reviewWriteContainer = document.getElementById('reviewWriteContainer');
            const loginRequired = document.getElementById('loginRequired');

            if (!currentUser) {
                reviewWriteContainer.style.display = 'none';
                loginRequired.style.display = 'block';
                return;
            }

            try {
                const res = await fetch(`/api/orders/has-product?productId=${productId}`, {
                    credentials: 'include'
                });
                const hasPurchased = await res.json();

                if (hasPurchased) {
                    reviewWriteContainer.style.display = 'block';
                    loginRequired.style.display = 'none';

                    // ë³„ì  ì´ˆê¸°í™” ë¡œì§
                    const stars = document.querySelectorAll('.star-rating .star');
                    stars.forEach((star, index) => {
                        star.addEventListener('click', () => {
                            selectedRating = index + 1;
                            updateStarRating();
                        });
                        star.addEventListener('mouseover', () => {
                            highlightStars(index + 1);
                        });
                    });
                    document.querySelector('.star-rating').addEventListener('mouseleave', () => {
                        updateStarRating();
                    });
                    updateStarRating();
                } else {
                    reviewWriteContainer.style.display = 'none';
                    loginRequired.style.display = 'none'; // êµ¬ë§¤ ì•ˆí–ˆìœ¼ë©´ ì•„ë¬´ê²ƒë„ ì•ˆë³´ì—¬ì¤Œ
                }
            } catch (err) {
                console.error("ë¦¬ë·° ê¶Œí•œ ì²´í¬ ì‹¤íŒ¨:", err);
                reviewWriteContainer.style.display = 'none';
                loginRequired.style.display = 'none';
            }
        }
    </script>
</body>
</html>